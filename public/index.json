
[{"content":"","date":"23 November 2025","externalUrl":null,"permalink":"/tags/android/","section":"Tags","summary":"","title":"Android","type":"tags"},{"content":"","date":"23 November 2025","externalUrl":null,"permalink":"/categories/","section":"Categories","summary":"","title":"Categories","type":"categories"},{"content":"","date":"23 November 2025","externalUrl":null,"permalink":"/categories/devops/","section":"Categories","summary":"","title":"Devops","type":"categories"},{"content":"","date":"23 November 2025","externalUrl":null,"permalink":"/tags/docker/","section":"Tags","summary":"","title":"Docker","type":"tags"},{"content":"Target Device: Xiaomi Mi 10T / 10T Pro (apollon)\nChipset: Snapdragon 865 (SM8250)\nOS: LineageOS 21/22 (Android 14/15)\nGoal: Enable native Docker support (Namespaces, Cgroups, OverlayFS) by patching and recompiling the kernel.\n1. Prerequisites (PC Side) # Install the necessary build tools on Arch Linux:\nsudo pacman -S base-devel git bc cpio zip unzip ncurses xmlto sudo pacman -S aarch64-linux-gnu-gcc arm-none-eabi-gcc 2. Get Source Code \u0026amp; Tools # Create a working directory and clone the necessary repositories.\nmkdir kernel_build \u0026amp;\u0026amp; cd kernel_build # 1. Clone the Kernel Source (SM8250 Common) git clone https://github.com/LineageOS/android_kernel_xiaomi_sm8250 -b lineage-22.2 kernel 3. Prepare the Environment # Run these commands in your terminal every time before running make.\ncd kernel export ARCH=arm64 export SUBARCH=arm64 export PATH=$(pwd)/../clang/bin:$PATH export CROSS_COMPILE=aarch64-linux-gnu- export CROSS_COMPILE_ARM32=arm-none-eabi- export CC=clang 4. Configuration (Defconfig) # The Mi 10T uses a fragmented configuration. You must merge the base, common, and device configs manually.\nA. Merge the Configs # # Combine Kona (Base) + SM8250 (Common) + Apollo (Device) cat arch/arm64/configs/vendor/kona-perf_defconfig \\ arch/arm64/configs/vendor/xiaomi/sm8250-common.config \\ arch/arm64/configs/vendor/xiaomi/apollo.config \\ \u0026gt; arch/arm64/configs/vendor/docker_apollon_defconfig B. Load the Config # make O=out vendor/docker_apollon_defconfig C. Enable Docker Flags # Run make O=out menuconfig and enable the following:\nGeneral setup [*] POSIX Message Queues Control Group support [*] Memory controller [*] Device controller Namespaces support [*] User namespace [*] PID Namespaces [*] IPC Namespaces Networking support -\u0026gt; Networking options -\u0026gt; Network packet filtering framework (Netfilter) [*] Bridged IP/ARP packets filtering Core Netfilter Configuration -\u0026gt; Netfilter Xtables support -\u0026gt; [*] addrtype address type match support File systems \u0026lt;*\u0026gt; Overlay filesystem support Disable WError (Crucial for modern compilers) Search for CC_WERROR (Press /) -\u0026gt; Uncheck [ ] Compile the kernel with warnings as errors 5. Applying Fixes (Modern Compiler Patching) # The kernel code is from ~2020. Modern GCC/Clang is too strict. We must patch the Makefile and source code to ignore specific errors.\nA. Patch the Makefile (Ignore Flags) # Add the following compiler flags to the Makefile to suppress specific errors:\nIgnore formatting errors: -Wno-error=format Ignore enum/int mismatch (Wi-Fi driver): -Wno-error=enum-int-mismatch Ignore indentation issues: -Wno-error=misleading-indentation Ignore array parameter mismatches: -Wno-error=array-parameter Ignore address checks: -Wno-error=address Ignore uninitialized variables: -Wno-error=maybe-uninitialized -Wno-error=uninitialized Here are the differences compared to the original Makefile:\ndiff --git a/Makefile b/Makefile index 40d2f3742..9fb6e87f9 100644 --- a/Makefile +++ b/Makefile @@ -444,7 +444,7 @@ LINUXINCLUDE := \\ $(USERINCLUDE) KBUILD_AFLAGS := -D__ASSEMBLY__ -KBUILD_CFLAGS := -Wall -Wundef -Wstrict-prototypes -Wno-trigraphs \\ +KBUILD_CFLAGS := -Wall -Wno-error=format -Wno-error=enum-int-mismatch -Wno-error=misleading-indentation -Wno-error=array-parameter -Wno-error=address -Wno-error=maybe-uninitialized -Wno-error=uninitialized -Wundef -Wstrict-prototypes -Wno-trigraphs \\ -fno-strict-aliasing -fno-common -fshort-wchar \\ -Werror-implicit-function-declaration \\ -Werror=return-type -Wno-format-security \\ B. Patch Source Code (bpf_trace.c) # The inline keyword causes an error in this specific file.\ndiff --git a/kernel/trace/bpf_trace.c b/kernel/trace/bpf_trace.c index 82fe096cb..d6a9d290e 100644 --- a/kernel/trace/bpf_trace.c +++ b/kernel/trace/bpf_trace.c @@ -360,7 +360,7 @@ static DEFINE_RAW_SPINLOCK(trace_printk_lock); #define BPF_TRACE_PRINTK_SIZE 1024 -static inline __printf(1, 0) int bpf_do_trace_printk(const char *fmt, ...) +static __printf(1, 0) int bpf_do_trace_printk(const char *fmt, ...) { static char buf[BPF_TRACE_PRINTK_SIZE]; unsigned long flags; 6. Compilation # Build the kernel. This takes 10–20 minutes.\nmake O=out -j$(nproc) Image.gz-dtb Result: File located at out/arch/arm64/boot/Image.gz-dtb (~22MB). 7. Packaging (AnyKernel3) # We use AnyKernel3 to create a flashable zip.\n# 1. Get AnyKernel3 cd .. git clone https://github.com/osm0sis/AnyKernel3 cd AnyKernel3 # 2. Clean dummy files rm Image zImage dtb 2\u0026gt;/dev/null # 3. Copy your new kernel cp ../kernel/out/arch/arm64/boot/Image.gz-dtb . CRITICAL: Fix anykernel.sh for Mi 10T # Edit anykernel.sh and make these specific changes:\nDisable Device Check: do.devicecheck=0 Hardcode Partition Path: block=/dev/block/bootdevice/by-name/boot Zip the Installer # zip -r9 ../Docker-Kernel-Apollon.zip * -x .git README.md *placeholder 8. Installation # Backup: Boot into Recovery (Lineage/TWRP) and backup the Boot partition (if possible). Flash: On Phone: Apply Update -\u0026gt; Apply from ADB. On PC: adb sideload Docker-Kernel-Apollon.zip Reboot: Restart System. 9. Post-Install Setup (Termux) # Once booted, open Termux (Root) and verify the kernel:\nsu zcat /proc/config.gz | grep \u0026#34;CONFIG_CGROUPS\u0026#34; # Should be =y Install Termux:Boot # Create the following scripts inside the ~/.termux/boot directory.\nsshd Auto Start (00-start-sshd.sh) # #!/data/data/com.termux/files/usr/bin/bash termux-wake-lock sshd Auto-Start Script (01-start-docker.sh) # Note: Replace \u0026lt;IP_GATEWAY\u0026gt; below with your actual router IP (e.g., 192.168.2.254).\n#!/data/data/com.termux/files/usr/bin/bash # 1. Switch to Root to set up Kernel \u0026amp; Docker # We use \u0026#39;su -c\u0026#39; to run these commands as root silently su -c \u0026#39; # Mount the \u0026#34;wires\u0026#34; (Cgroups) mount -t tmpfs -o mode=755 tmpfs /sys/fs/cgroup mkdir -p /sys/fs/cgroup/devices mount -t cgroup -o devices cgroup /sys/fs/cgroup/devices mkdir -p /sys/fs/cgroup/cpu mount -t cgroup -o cpu cgroup /sys/fs/cgroup/cpu mkdir -p /sys/fs/cgroup/memory mount -t cgroup -o memory cgroup /sys/fs/cgroup/memory # Fix routing to use bridge network iptables -P FORWARD ACCEPT iptables -I FORWARD -j ACCEPT iptables -t nat -F POSTROUTING iptables -t nat -A POSTROUTING -o wlan0 -j MASQUERADE # Fix Android Policy Routing (Allow Docker traffic to use Main table) ip rule add pref 1 from all lookup main # Restore Gateway (Android wipes this from Main table) ip route add default via \u0026lt;IP_GATEWAY\u0026gt; dev wlan0 2\u0026gt;/dev/null # Fix Path for Root export PATH=/data/data/com.termux/files/usr/bin:$PATH # Start Docker Daemon silently dockerd \u0026gt; /dev/null 2\u0026gt;\u0026amp;1 \u0026amp; # Allow User to Run Docker (Non-Root) sleep 5 # Wait for socket to be created chmod 666 /data/data/com.termux/files/usr/var/run/docker.sock \u0026#39; Deploy Nginx Container # Now you can run containers as a normal user:\ndocker run -d --rm -p 8080:80 nginx:latest Try accessing it at \u0026lt;Phone_IP\u0026gt;:8080.\n","date":"23 November 2025","externalUrl":null,"permalink":"/posts/docker-kernel-compilation-guide-for-xiaomi-mi-10t-apollon/","section":"Posts","summary":"","title":"Docker Kernel Compilation Guide for Xiaomi Mi 10T (Apollon)","type":"posts"},{"content":"","date":"23 November 2025","externalUrl":null,"permalink":"/","section":"Episto","summary":"","title":"Episto","type":"page"},{"content":"","date":"23 November 2025","externalUrl":null,"permalink":"/tags/kernel/","section":"Tags","summary":"","title":"Kernel","type":"tags"},{"content":"","date":"23 November 2025","externalUrl":null,"permalink":"/categories/mobile/","section":"Categories","summary":"","title":"Mobile","type":"categories"},{"content":"","date":"23 November 2025","externalUrl":null,"permalink":"/posts/","section":"Posts","summary":"","title":"Posts","type":"posts"},{"content":"","date":"23 November 2025","externalUrl":null,"permalink":"/tags/","section":"Tags","summary":"","title":"Tags","type":"tags"},{"content":"","date":"23 November 2025","externalUrl":null,"permalink":"/tags/xiaomi/","section":"Tags","summary":"","title":"Xiaomi","type":"tags"},{"content":"","date":"15 November 2025","externalUrl":null,"permalink":"/tags/bd_prochot/","section":"Tags","summary":"","title":"Bd_prochot","type":"tags"},{"content":"Summary: If your modern Linux laptop locks its CPU speed to the absolute minimum (often 200MHz or 400MHz) when on battery, despite power profiles being set to \u0026lsquo;Balanced,\u0026rsquo; the problem is likely firmware—not software. This guide provides the definitive hardware workaround using Model Specific Registers (MSRs) to disable the rogue BD_PROCHOT signal.\n1. The Frustrating Symptom # You\u0026rsquo;ve got a powerful laptop, running a stable distribution like Omarchy OS (or Arch, Fedora, etc.).\nPlugged In: The CPU runs perfectly, hitting its advertised boost speeds (3 GHz or more). On Battery: The CPU instantly locks to its minimum frequency, often 200MHz or 400MHz. The system becomes sluggish, even under zero load. The Check: You check your power settings: powerprofilesctl get shows balanced. The CPU governor is correctly set to the dynamic powersave (when using Intel P-State). $ cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor powersave No obvious culprits like TLP or auto-cpufreq are installed. This behavior is a strong indicator that the operating system has been overridden by the hardware\u0026rsquo;s firmware.\n2. The Root Cause: BD_PROCHOT and the New Battery # The likely cause, especially if you recently replaced the laptop battery, is the BD_PROCHOT (Bi-Directional Processor Hot) signal.\nWhat it is: BD_PROCHOT is a safety signal asserted by the laptop\u0026rsquo;s Embedded Controller (EC). It forces the CPU to hard-throttle to its minimum frequency regardless of the OS settings. Why it Triggers: Laptops are often programmed to trigger this safety signal if the EC detects a potential power fault. A common scenario is when a replacement or non-OEM battery is installed, and the EC cannot verify its power signature or accurately read its status. The EC defaults to maximum safety, resulting in the aggressive 200 MHz lock. Since this signal operates below the kernel level, a software configuration change won\u0026rsquo;t fix it—we need a surgical software workaround.\n3. The Definitive Fix: Disabling BD_PROCHOT via MSR # The solution is to use the wrmsr (Write Model Specific Register) utility to tell the CPU to ignore the BD_PROCHOT signal.\nStep 3.1: Create the MSR-Write Script # The safest way to disable the signal is to read the register\u0026rsquo;s current value, clear only the single bit responsible for the throttle (Bit 0), and write the modified value back.\nFirst, ensure you have the msr-tools package installed (e.g., sudo pacman -S msr-tools).\nCreate the script at /usr/local/bin/disable-bd-prochot.sh:\n#!/bin/bash set -euo pipefail echo \u0026#34;[BD_PROCHOT] Starting disable script...\u0026#34; # Load msr module if not already loaded if ! lsmod | grep -q \u0026#39;^msr\u0026#39;; then echo \u0026#34;[BD_PROCHOT] Loading msr module...\u0026#34; modprobe msr || { echo \u0026#34;[BD_PROCHOT] Failed to load msr module!\u0026#34;; exit 1; } fi # Wait until /dev/cpu/0/msr exists (some systems take a moment) for i in {1..5}; do if [ -e /dev/cpu/0/msr ]; then break fi echo \u0026#34;[BD_PROCHOT] Waiting for /dev/cpu/0/msr...\u0026#34; sleep 1 done if [ ! -e /dev/cpu/0/msr ]; then echo \u0026#34;[BD_PROCHOT] Error: /dev/cpu/0/msr not found!\u0026#34; exit 1 fi # Read current MSR (0x1FC) value from core 0 CURRENT_VAL=$(rdmsr -d 0x1FC) || { echo \u0026#34;[BD_PROCHOT] Failed to read MSR!\u0026#34; exit 1 } echo \u0026#34;[BD_PROCHOT] Current MSR value: $CURRENT_VAL\u0026#34; # Check if BD_PROCHOT bit is set (bit 0) if (( CURRENT_VAL % 2 == 1 )); then NEW_VAL=$((CURRENT_VAL - 1)) echo \u0026#34;[BD_PROCHOT] Disabling BD_PROCHOT (new value: $NEW_VAL)\u0026#34; wrmsr -a 0x1FC \u0026#34;$NEW_VAL\u0026#34; echo \u0026#34;[BD_PROCHOT] BD_PROCHOT cleared on all cores.\u0026#34; else echo \u0026#34;[BD_PROCHOT] BD_PROCHOT already disabled.\u0026#34; fi echo \u0026#34;[BD_PROCHOT] Done.\u0026#34; Important: Make the script executable: sudo chmod +x /usr/local/bin/disable-bd-prochot.sh\nStep 3.2: Create the Systemd Service # Since MSR settings are volatile (they reset on every reboot), we must create a systemd service to run this script automatically at startup.\nCreate the service file at /etc/systemd/system/bd-prochot-fix.service:\n[Unit] Description=Disable BD_PROCHOT to fix 200MHz throttling # Ensure the service runs AFTER the required kernel modules and filesystems are ready After=sysinit.target local-fs.target Requires=sysinit.target [Service] Type=oneshot # The script will load the msr module and run wrmsr ExecStart=/usr/local/bin/disable-bd-prochot.sh StandardOutput=journal StandardError=journal [Install] # Attach the service to the standard environment that desktop/multi-user systems use. WantedBy=multi-user.target Step 3.3: Enable and Start the Service # Finally, apply the service changes and enable it permanently:\nsudo systemctl daemon-reload # Reload systemd manager sudo systemctl enable --now bd-prochot-fix.service # Enable and run immediately 4. Final Thoughts on Safety # Disabling BD_PROCHOT is a powerful workaround that removes a hardware-level safety switch. While modern CPUs have internal temperature protection, it is always recommended to monitor your CPU temperatures when running intensive tasks after applying this fix, especially on battery.\nTo check your logs and ensure the script ran correctly after a reboot:\njournalctl -u bd-prochot-fix.service -b ","date":"15 November 2025","externalUrl":null,"permalink":"/posts/cpu-throttling/","section":"Posts","summary":"","title":"CPU Throttling","type":"posts"},{"content":"","date":"15 November 2025","externalUrl":null,"permalink":"/tags/linux/","section":"Tags","summary":"","title":"Linux","type":"tags"},{"content":"","date":"15 November 2025","externalUrl":null,"permalink":"/tags/msr/","section":"Tags","summary":"","title":"Msr","type":"tags"},{"content":"","date":"15 November 2025","externalUrl":null,"permalink":"/tags/power-management/","section":"Tags","summary":"","title":"Power Management","type":"tags"},{"content":"","date":"15 November 2025","externalUrl":null,"permalink":"/categories/sysadmin/","section":"Categories","summary":"","title":"Sysadmin","type":"categories"},{"content":"","date":"15 November 2025","externalUrl":null,"permalink":"/tags/systemd/","section":"Tags","summary":"","title":"Systemd","type":"tags"},{"content":"","date":"15 November 2025","externalUrl":null,"permalink":"/tags/throttling/","section":"Tags","summary":"","title":"Throttling","type":"tags"},{"content":"","date":"31 August 2025","externalUrl":null,"permalink":"/tags/traefik/","section":"Tags","summary":"","title":"Traefik","type":"tags"},{"content":"This is basic traefik configuration that often I use when using traefik. This configuration focusing on using file providers as traefik configuration therefore the docker-compose.yaml looks clean. But as for the downside, you need to copy multiple files like the docker-compose.yaml and traefik.yaml as base configuration. Then the dynamic configuration files need to be created based on your needs.\nThis docker-compose.yaml file will create 2 containers; traefik and whoami service to test if this configuration working as we want.\nservices: traefik: image: traefik:latest restart: always environment: - \u0026#34;TZ=Asia/Jakarta\u0026#34; ports: - \u0026#34;80:80\u0026#34; - \u0026#34;443:443\u0026#34; - \u0026#34;8080:8080\u0026#34; volumes: - ./traefik.yaml:/etc/traefik/traefik.yaml - ./dynamic:/etc/traefik/dynamic - ./letsencrypt:/etc/traefik/letsencrypt healthcheck: test: [\u0026#34;CMD\u0026#34;, \u0026#34;traefik\u0026#34;, \u0026#34;healthcheck\u0026#34;] interval: 60s retries: 3 whoami: image: traefik/whoami restart: always This traefik.yaml file is the base configuration for traefik. It already includes HTTP Redirection to HTTPS, SSL Automatic Renewal, and automatic configuration discovery. Additional notes, if you want the dynamic configuration to be applied automatically, it should be referenced as a file inside providers.file.directory. If you add new directory inside it and put the configuration inside the child directory, then the automatic reload will not work.\nentryPoints: web: address: \u0026#34;:80\u0026#34; http: redirections: entryPoint: to: websecure scheme: https websecure: address: \u0026#34;:443\u0026#34; api: dashboard: true insecure: false debug: false log: format: json level: INFO accessLog: addInternals: true format: json filters: statusCodes: - \u0026#34;200\u0026#34; - \u0026#34;400-404\u0026#34; - \u0026#34;500-503\u0026#34; retryAttempts: true minDuration: \u0026#34;10ms\u0026#34; certificatesResolvers: letsencrypt: acme: email: \u0026#34;test@example.com\u0026#34; storage: \u0026#34;/etc/traefik/letsencrypt/acme.json\u0026#34; httpChallenge: entryPoint: web providers: file: directory: \u0026#34;/etc/traefik/dynamic\u0026#34; watch: true This is a basic dynamic configuration to route all request to domain example.com to be received by service-whoami\nhttp: routers: router-whoami: rule: \u0026#34;Host(`example.com`)\u0026#34; service: service-whoami services: service-whoami: loadBalancer: servers: - url: http://whoami:80 ","date":"31 August 2025","externalUrl":null,"permalink":"/posts/traefik-configuration-starter/","section":"Posts","summary":"","title":"Traefik Configuration Starter","type":"posts"},{"content":"","externalUrl":null,"permalink":"/authors/","section":"Authors","summary":"","title":"Authors","type":"authors"},{"content":"","externalUrl":null,"permalink":"/series/","section":"Series","summary":"","title":"Series","type":"series"}]